***************
*** 406,418 ****
    width = widthA;
    nComps = nCompsA;
    nBits = nBitsA;
  
    nVals = width * nComps;
    pixBytes = (nComps * nBits + 7) >> 3;
    rowBytes = ((nVals * nBits + 7) >> 3) + pixBytes;
    predLine = (Guchar *)gmalloc(rowBytes);
    memset(predLine, 0, rowBytes);
    predIdx = rowBytes;
  }
  
  StreamPredictor::~StreamPredictor() {
--- 407,432 ----
    width = widthA;
    nComps = nCompsA;
    nBits = nBitsA;
+   predLine = NULL;
+   ok = gFalse;
  
    nVals = width * nComps;
+   if (width <= 0 || nComps <= 0 || nBits <= 0 ||
+       nComps >= INT_MAX / nBits ||
+       width >= INT_MAX / nComps / nBits ||
+       nVals * nBits + 7 < 0) {
+     return;
+   }
    pixBytes = (nComps * nBits + 7) >> 3;
    rowBytes = ((nVals * nBits + 7) >> 3) + pixBytes;
+   if (rowBytes <= 0) {
+     return;
+   }
    predLine = (Guchar *)gmalloc(rowBytes);
    memset(predLine, 0, rowBytes);
    predIdx = rowBytes;
+ 
+   ok = gTrue;
  }
  
  StreamPredictor::~StreamPredictor() {
***************
*** 1004,1009 ****
      FilterStream(strA) {
    if (predictor != 1) {
      pred = new StreamPredictor(this, predictor, columns, colors, bits);
    } else {
      pred = NULL;
    }
--- 1018,1027 ----
      FilterStream(strA) {
    if (predictor != 1) {
      pred = new StreamPredictor(this, predictor, columns, colors, bits);
+     if (!pred->isOk()) {
+       delete pred;
+       pred = NULL;
+     }
    } else {
      pred = NULL;
    }
***************
*** 3854,3859 ****
      FilterStream(strA) {
    if (predictor != 1) {
      pred = new StreamPredictor(this, predictor, columns, colors, bits);
    } else {
      pred = NULL;
    }
--- 3891,3900 ----
      FilterStream(strA) {
    if (predictor != 1) {
      pred = new StreamPredictor(this, predictor, columns, colors, bits);
+     if (!pred->isOk()) {
+       delete pred;
+       pred = NULL;
+     }
    } else {
      pred = NULL;
    }
